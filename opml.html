<html><head><title>live list editor</title>
<style type="text/css">
.item_text {
    background: #ccc;
}
</style>
<script lang="text/javascript">

// syntactic sugar ///////////////////////////////////////////////////////////
// and helper functions

function wrap(wrapper,sweetie) {
    var x = document.createElement(wrapper);
    x.appendChild(sweetie);
    return x;
}

function clear_children(something) {
    while (something.childNodes.length >= 1) {
        something.removeChild(something.firstChild);
    } 
}

// cursor functions //////////////////////////////////////////////////////////
// The cursor is a DOM snippet which represents a selected item

function create_cursor() {
    var cursor = document.createElement("input");
    cursor.setAttribute("type", "text");
    cursor.setAttribute("id", "cursor");
    cursor.setAttribute("style", "width: 90%");

    cursor.addEventListener("keypress", function(evt) {

        if(evt.keyCode == 40) { //down
            var li = cursor.parentNode;
            var sib = li.nextSibling;
            if(null != sib) {
                sib.parentNode.removeChild(li);
                sib.parentNode.insertBefore(li, sib.nextSibling);
                cursor.focus();
            }

        } else if(evt.keyCode == 38) { // up
            var li = cursor.parentNode;
            var sib = li.previousSibling;
            if(null != sib) {
                sib.parentNode.removeChild(li);
                sib.parentNode.insertBefore(li, sib);
                cursor.focus();
            }
        } else if(evt.keyCode == 39) { // right
            // parentul/li/cursor - parentul/li/ul/li2/cursor
            var li = cursor.parentNode;
            var sib = li.nextSibling;
            li.removeChild(cursor);
            li.appendChild(wrap("ul", wrap("li", cursor)));
            cursor.focus();
        } else if(evt.keyCode == 37) { // left
            // grandparentul/li/parentul/cursor? -> grandparentul/cursor
            // parentul/cursor? -> parentul/cursor
            // check parents against id=mainlist for root
        }

    }, false);

    return cursor;
}

// detach the cursor object from the DOM if attached and return it here
function get_cursor() {
    var cursor = document.getElementById("cursor");
    if(null != cursor) {
        var par = cursor.parentNode;
        var newitem = create_item(cursor.value);
        clear_children(par);
        par.appendChild(newitem);
    } else {
        cursor = create_cursor();
    }
    return cursor;
}

// item functions ////////////////////////////////////////////////////////////
// an item is text, wrapped up in a DOM segment.
// the DOM segment is a span with nested spans within

// set the given item as active (move the cursor to it)
function set_active_item(item) {
    var cursor = get_cursor();
    var par = item.parentNode;
    // XXX: the following assumes item.firstChild is the required span
    cursor.value = get_item_text(item);
    clear_children(par);
    par.appendChild(cursor);
}

// create a new item
// * span
//   * span item_text
//     * text: new item
//   * span item_controls
//     * a
//       * text: (delete)
function create_item(item_text) {
    var span_item_text = wrap("span", document.createTextNode(item_text));
    span_item_text.setAttribute("class", "item_text");

    var span_item = wrap("span",span_item_text);

    span_item_text.addEventListener("click", function () {
       set_active_item(span_item);
    }, false);

    var a = wrap("a", document.createTextNode("delete"));
    a.href = '#';
    a.addEventListener("click", function () {
        var pa      = span_item.parentNode;
        var grandpa = pa.parentNode;
        grandpa.removeChild(pa);
    }, false);
    var span_item_controls = wrap("span", document.createTextNode(' ('));
    span_item_controls.appendChild(a);
    span_item_controls.appendChild(document.createTextNode(')'));
    span_item.appendChild(span_item_controls);
    span_item_controls.style.display = 'none';
    span_item.addEventListener("mouseover", function(evt) { // ie uses onmouseover
        span_item_controls.style.display = 'inline';
    }, false);
    span_item.addEventListener("mouseout", function(evt) { // ie uses onmouseover
        span_item_controls.style.display = 'none';
    }, false);
    return span_item;
}

// fetch the textual data out of an item
function get_item_text(item) {
       // XXX: I'm sure item.data should work here but it doesn't
       return item.firstChild.innerHTML;
}

// event hooks ///////////////////////////////////////////////////////////////

// add a new item to the list
function additem() {
    var mainlist = document.getElementById("mainlist");
    var item = create_item('new item'); 
    mainlist.insertBefore(wrap("li", item), null);
    set_active_item(item);
    return false;
}

// initialisation stuff
function list_startup() {
    document.getElementById("mainlist").appendChild(wrap("li",create_item('first item')));
}

function debugme() {
    alert(document.getElementById('thebody').innerHTML);
}

</script>

</head>
<body id="thebody" onload="list_startup()";>
<ul id="mainlist">
</ul>
<input type="submit" onclick="debugme();" value="debugme" />
<input type="submit" onclick="additem();" value="new item" />

</body></html>
