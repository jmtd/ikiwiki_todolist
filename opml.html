<html><head><title>live list editor</title>
<style type="text/css">
.item_text {
    background: #ccc;
}
.item {
    background: #cfc;
    padding-left: 1em;
    padding-right: 1em;
}
</style>
<script lang="text/javascript">

// syntactic sugar ///////////////////////////////////////////////////////////
// and helper functions

function wrap(wrapper,sweetie) {
    var x = document.createElement(wrapper);
    x.appendChild(sweetie);
    return x;
}

// cursor functions //////////////////////////////////////////////////////////
// The cursor is a DOM snippet which represents a selected item

function create_cursor() {
    var cursor = document.createElement("input");
    cursor.setAttribute("type", "text");
    cursor.setAttribute("id", "cursor");
    cursor.setAttribute("style", "width: 90%");

    cursor.addEventListener("keypress", function(evt) {

        if(evt.keyCode == 40) { //down
            var li = cursor.parentNode;
            var sib = li.nextSibling;
            if(null != sib) {
                select_item(sib.firstChild);
            }

        } else if(evt.keyCode == 38) { // up
            var li = cursor.parentNode;
            var sib = li.previousSibling;
            if(null != sib) {
                select_item(sib.firstChild);
            }
        } else if(evt.keyCode == 39) { // right
            // parentul/li/cursor - parentul/li/item ul/li2/cursor
            var li = cursor.parentNode;
            deselect_item(cursor);
            var newitem = create_item('new item');
            li.appendChild(wrap("ul", wrap("li", newitem)));
            select_item(newitem);

        } else if(evt.keyCode == 37) { // left
            // grandparentul/li/stuff parentul/li/cursor -> grandparentul/li/cursor
            var newfocus = cursor;
            var root = document.getElementById("mainlist");
            for(var i = 0; i < 3; ++i) {
                newfocus = newfocus.parentNode;
                if(null == newfocus || root == newfocus) {
                    return; // XXX: slightly uncomfortable with this
                }
            }
            select_item(newfocus.firstChild);
        }

    }, false);

    return cursor;
}

// detach the cursor object from the DOM if attached and return it here
function get_cursor() {
    var cursor = document.getElementById("cursor");
    if(null != cursor) {
        var par = cursor.parentNode;
        par.replaceChild(create_item(cursor.value), cursor);
    } else {
        cursor = create_cursor();
    }
    return cursor;
}

// return whether the cursor is currently deployed
function cursor_is_active() {
    var cursor = get_cursor();
    return null != cursor.parentNode;
}

// item functions ////////////////////////////////////////////////////////////
// an item is text, wrapped up in a DOM segment.
// the DOM segment is a span with nested spans within

// create a new item
// * div
//   * span item_text
//     * text: new item
//   * span item_controls
//     * a
//       * text: (delete)
//   * div item_subtree
//       (initially empty)
function create_item(item_text) {
    var span_item_text = wrap("span", document.createTextNode(item_text));
    span_item_text.setAttribute("class", "item_text");

    var div_item = wrap("span",span_item_text);
    div_item.setAttribute("class","item");

    span_item_text.addEventListener("click", function () {
       select_item(div_item);
    }, false);

    var a = wrap("a", document.createTextNode("delete"));
    a.href = '#';
    a.addEventListener("click", function () {
        var pa      = div_item.parentNode;
        var grandpa = pa.parentNode;
        grandpa.removeChild(pa);
    }, false);
    var span_item_controls = wrap("span", document.createTextNode(' ('));
    span_item_controls.appendChild(a);
    span_item_controls.appendChild(document.createTextNode(')'));
    div_item.appendChild(span_item_controls);
    span_item_controls.style.display = 'none';
    div_item.addEventListener("mouseover", function(evt) { // ie uses onmouseover
        span_item_controls.style.display = 'inline';
    }, false);
    div_item.addEventListener("mouseout", function(evt) { // ie uses onmouseover
        span_item_controls.style.display = 'none';
    }, false);
    return div_item;
}

// fetch the textual data out of an item
function get_item_text(item) {
       // XXX: I'm sure item.data should work here but it doesn't
       return item.firstChild.innerHTML;
}

// selecting and deselecting items ///////////////////////////////////////////

function item_is_selected(item) {
    return "cursor" == item.getAttribute("id");
}

function deselect_item(item) {
    if(!item_is_selected(item)) {
        return;
    }
    var par = item.parentNode;
    var newitem = create_item(item.value);
    par.replaceChild(newitem, item);
}

function select_item(item) {
    if(item_is_selected(item)) {
        return;
    }
    var cursor = get_cursor();
    if(cursor_is_active()) {
        deselect_item(cursor);
    }
    var par = item.parentNode;
    // XXX: the following assumes item.firstChild is the required span
    cursor.value = get_item_text(item);
    par.replaceChild(cursor, item);
    cursor.focus();
}

// event hooks ///////////////////////////////////////////////////////////////

// add a new item to the list
function additem() {
    var mainlist = document.getElementById("mainlist");
    var item = create_item('new item'); 
    mainlist.insertBefore(wrap("li", item), null);
    select_item(item);
    return false;
}

// initialisation stuff
function list_startup() {
    var first = create_item('first item');
    document.getElementById("mainlist").appendChild(wrap("li",first));
    select_item(first);
}

function debugme() {
    alert(document.getElementById('thebody').innerHTML);
}

</script>

</head>
<body id="thebody" onload="list_startup()";>
<ul id="mainlist">
</ul>
<input type="submit" onclick="debugme();" value="debugme" />
<input type="submit" onclick="additem();" value="new item" />

</body></html>
